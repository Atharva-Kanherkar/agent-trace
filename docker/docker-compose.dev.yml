services:
  dashboard:
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ..:/app
      - dashboard_node_modules:/app/node_modules
    command: >
      bash -lc "npm ci --include=dev &&
      npm run --workspace @agent-trace/dashboard build:web &&
      npm run --workspace @agent-trace/dashboard start:web -- --hostname 0.0.0.0 --port 3100"

  collector:
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ..:/app
      - collector_node_modules:/app/node_modules
    command: >
      bash -lc "npm ci --include=dev &&
      npm run --workspace @agent-trace/runtime build &&
      node packages/runtime/dist/src/cli.js"

  api:
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ..:/app
      - api_node_modules:/app/node_modules
    command: >
      bash -lc "npm ci --include=dev &&
      npm run --workspace @agent-trace/runtime build &&
      node packages/runtime/dist/src/cli.js"

volumes:
  dashboard_node_modules:
  collector_node_modules:
  api_node_modules:
